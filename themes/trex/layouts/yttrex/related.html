{{ define "main" -}}

<header class="jumbotron">
    <div class="container">
        <div class="text-center">
            <h1>{{ .Title }}</h1>
            <time class="post-date d-none" datetime='{{ .Date.Format "2006-01-02T15:04:05Z0700" }}'>{{ .Date.Format "Mon, Jan 2, 2006" }}</time>
        </div>
    </div>
</header>

<div class="container">
    {{ .Content }}
    <span class="clearfix"></span>

    <input class="entry" type="text" id="search" placeholder="youtube.com/watch?v=...">
    <input type="button" value="view" onclick="submit()">

    <p id="notes"></p>
    <div id="related"></div>
</div>

<script type="text/javascript">

    $( document ).ready(function() {

        function initRelated() {
            const rId = window.location.href.split('/#').pop();
            if (rId == 'compare') return;
            $("#search").val(rId);
            $.getJSON('https://youtube.tracking.exposed/api/v1/related/' + rId, function (results) {
                if (_.size(results) === 0) {
                    const nope = `
                        <p>Nope, a video with such id has been never found among the evidence collected</p>
                        <p>Check if is a valid video, here is the composed link:
                            <a href="https://youtube.com/watch?v=${rId}">https://youtube.com/watch?v=${rId}</a>
                        </p>
                    `;
                    $("#notes").append(nope);
                    return;
                }

                const target = _.find(results[0].related, {videoId: rId});
                const hdr = `
                    <div class="centered protagonist">
                        <div class="fullred">${_.size(results)} videos linked to this
                            <a class="notclassiclink" href="/yttrex/compare/#${rId}">â†’  compare</a>
                        </div>
                        <div>${target.title}
                            <a target=_blank href="https://www.youtube.com/watch?v=${results[0].videoId}">ðŸž‚</a>
                        </div>
                        ${target.source}
                    </div>
                    <div class="centered fullred">Check the list below</div>
                `;
                $('#related').append(hdr);

                _.each(results, function (watched) {
                    const index = _.find(watched.related, {videoId: rId}).index;
                    let videoEntry = `
                        <div id="${watched.videoId}" class="step">
                            <span class="video">
                                <label>Primary video:</label><a class="primary" href="/yttrex/compare/#${watched.videoId}">${watched.title}</a>
                                <a target=_blank href="https://www.youtube.com/watch?v=${watched.videoId}">ðŸž‚</a>
                            </span>
                            <span class="author">
                                <label>Primary channel:</label>${watched.authorName}
                            </span>
                            <span class="position">
                                <label>Position:</label>${index}
                            </span>
                            <span>
                                <label>Saved on:</label>${watched.timeago} ago
                            </span>
                        </div>
                    `;
                    $('#related').append(videoEntry);
                });

            });
        }

        initRelated();
    });
    function submit() {
        const submitted = $("#search").val();
        const videoId = submitted.replace(/.*v=/, '');
        if (_.size(videoId) < 9 || _.size(videoId) > 12) return;
        window.location.replace('/yttrex/related/#' + videoId);
        location.reload();
    }
</script>

{{- end }}