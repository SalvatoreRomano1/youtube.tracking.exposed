{{ define "main" -}}

<header class="jumbotron">
    <div class="container">
        <div class="text-center">
            <h1>{{ .Title }}</h1>
            <time class="post-date d-none" datetime='{{ .Date.Format "2006-01-02T15:04:05Z0700" }}'>{{ .Date.Format "Mon, Jan 2, 2006" }}</time>
        </div>
    </div>
</header>

<div class="container">
    {{ .Content }}
    <span class="clearfix"></span>

    <h2>Compare how the same video get different reccomendations</h2>
    <div id="comparison"></div>


    <h2>Try in our recent collections</h2>
    <div id="recent"></div>
</div>

<script type="text/javascript">

    $( document ).ready(function() {

        function fillRecentSlot(item) {

            let h = `
                <div class="recent">
                    <label>${item.timeago}</label>
                    <label>Related: ${item.relatedN}</label>
                    <a class="linked" onclick="newVideo('${item.videoId}');" href="/yttrex/compare/#${item.videoId}">${item.title}</a>
                </div>
            `;
            $('#recent').append(h);
        }

        // #recent and #comparison
        // with 'last' we populate some snippet
        // with 'getVideoId' we get the videos, it is display the different comparison
        function initCompare() {

            const cId = window.location.href.split('/#').pop();
            if (cId == 'compare') return;
            $.getJSON('https://youtube.tracking.exposed/api/v1/videoId/' + cId, function (results) {

                if (_.size(results) == 0) {
                    const nope = `
                        <h3 class="fullred">Nope, this video has never been watched by someone with ytTREX extension</h3>
                        <p>Check if is a valid video, here is the composed link:
                            <a href="https://youtube.com/watch?v=${cId}">https://youtube.com/watch?v=${cId}</a>
                        </p>
                    `;
                    $("#comparison").append(nope);
                    return;
                }

                const allrelated = _.flatten(_.map(results, 'related'));
                const hdr = `
                    <div class="comparehdr"><div class="fullred">${_.size(results)} times has been seen this video, and YT gave ${_.size(allrelated)} related videos</div>
                        <div class="protagonist"><a href="/related/${results[0].videoId}">${results[0].title}</a>
                            <a target=_blank href="https://www.youtube.com/watch?v=${results[0].videoId}">ðŸž‚</a>
                        </div>
                    </div>
                `;

                $('#comparison').append(hdr);

                const x = _.reverse(_.orderBy(_.groupBy(allrelated, 'videoId'), _.size));

                let lastH = null;
                _.each(x, function (relatedList) {

                    if (_.size(relatedList) != lastH) {
                        lastH = _.size(relatedList);
                        let printed = lastH > 1 ? lastH + " times" : "once";
                        let sightenings = `
                            <div class="seen">
                                Videos present among the "related list" ${printed}:
                            </div>
                        `;
                        $('#comparison').append(sightenings);
                    }

                    const positions = _.join(_.map(relatedList, 'index'), ', ');
                    const relatedVideo = _.first(relatedList);
                    let videoEntry = `
                        <div id="${relatedVideo.videoId}" class="step">
                            <span class="author">
                                <label>Channel:</label>${relatedVideo.source}
                            </span>
                            <span class="position">
                                <label>Positions:</label>${positions}
                            </span>
                            <span class="video">
                                <label>Video:</label><a class="linked" href="/yttrex/related/#${relatedVideo.videoId}">${relatedVideo.title}</a>
                                <a target=_blank href="https://www.youtube.com/watch?v=${relatedVideo.videoId}">ðŸž‚</a>
                            </span>
                        </div>
                    `;
                    $('#comparison').append(videoEntry);
                });
            });

            $.getJSON('https://youtube.tracking.exposed/api/v1/last', function (recent) {
                _.each(recent.content, fillRecentSlot);

            });

        }
        initCompare();
    });

    function newVideo(videoID) {
        window.location.assign('#' + videoID);
        location.reload();
    }
</script>

{{- end }}
